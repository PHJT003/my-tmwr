---
title: "Basics"
author: "Valerio Villani"
date: "30/03/2021"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, error=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidymodels)

theme_set(theme_bw())

```

# The Ames housing data

## Goal

Predict the sale price of a house based on its other characteristics.

```{r echo=FALSE, include=FALSE}

data(ames, package = "modeldata")

ames <- janitor::clean_names(ames)

glimpse(ames)

```

## EDA

```{r echo=FALSE}

ames %>% 
  ggplot(aes(x = sale_price)) +
  geom_histogram(bins = 50) +
  # visualise log-transformed data
  scale_x_log10()


```
```{r include=FALSE}

# apply log-transform to sale_price
ames <- ames %>% mutate(sale_price = log10(sale_price))

```


# Spending our data

The *data spending* stage is where we decide the proportion of our **train/test split**.

## Common methods for splitting data

```{r}

set.seed(123)

# calculate quantiles
qtls <- quantile(ames$sale_price, 
                 probs = c(0.25, 0.50, 0.75))

# visualise quantiles for stratified sampling
ames %>% 
  ggplot(aes(x = sale_price)) +
  geom_density() +
  geom_vline(xintercept = qtls, linetype = "dashed" ) +
  labs(x = "Sale price (log-10 USD)")



# split data into 80% train and 20% test
ames_split <- initial_split(ames, prop = 0.80,
                            # sample according to quartiles
                            strata = sale_price)

# get the train data
ames_train <- training(ames_split)

# get the test data
ames_test <- testing(ames_split)

```

# Feature engineering

Feature engineering encompasses activities that reformat predictor values to make them easier for a model to use effectively (e.g., transformations).


```{r}

lm(sale_price ~ neighborhood + log10(gr_liv_area) + year_built + bldg_type,
   data = ames)

```
Remember that when invoking the `recipe()` function, the steps are not estimated or executed in any way. The second phase for using a recipe is to estimate any quantities required by the steps using the `prep()` function.

```{r}

# create a lm() recipe
simple_ames <- 
  recipe(sale_price ~ neighborhood + gr_liv_area + year_built + bldg_type,
         data = ames_train) %>% 
  # log-transform "general living area" variable
  step_log(gr_liv_area, base = 10) %>% 
  # dummy-code all factors
  step_dummy(all_nominal())

simple_ames
  

```

